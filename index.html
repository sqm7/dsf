<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>進階地圖資料匯出工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.1.3/24/outline/css/heroicons.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .sidebar::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 3px;
        }
        #jsonStyleInput {
            font-family: monospace;
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .btn-disabled {
            background-color: #4b5563;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-200 flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-96 bg-gray-900/80 backdrop-blur-sm border-r border-gray-700/60 flex flex-col h-screen">
        <header class="p-4 border-b border-gray-700/60">
            <h1 class="text-xl font-bold text-white">進階地圖匯出工具</h1>
            <p class="text-sm text-gray-400">客製化、擷取並匯出地理資料</p>
        </header>

        <div class="flex-grow p-4 overflow-y-auto sidebar">
            <!-- API Key Input -->
            <div class="mb-6 p-4 bg-gray-800 rounded-lg border border-yellow-500/30">
                <label for="apiKeyInput" class="block text-sm font-medium text-yellow-400 mb-2">Google Maps API 金鑰</label>
                <input type="text" id="apiKeyInput" placeholder="在此貼上您的 API 金鑰" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                <button id="loadMapBtn" class="w-full mt-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200 text-sm">載入地圖</button>
                 <p class="text-xs text-gray-500 mt-2">需要 API 金鑰才能啟用所有地圖功能。 <a href="https://developers.google.com/maps/documentation/javascript/get-api-key" target="_blank" class="text-blue-400 hover:underline">如何取得金鑰？</a></p>
            </div>

            <!-- Map Style Editor -->
            <div class="mb-4">
                <h2 class="text-lg font-semibold mb-2 text-white">地圖樣式編輯器</h2>
                <textarea id="jsonStyleInput" rows="10" class="w-full bg-gray-700/50 border border-gray-600 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                <button id="applyStyleBtn" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200 text-sm btn-disabled" disabled>應用樣式</button>
            </div>

            <!-- Export Controls -->
            <div>
                <h2 class="text-lg font-semibold mb-3 text-white">資料匯出</h2>
                <div class="space-y-3">
                    <div>
                        <h3 class="font-medium text-gray-300 mb-2">2D 向量資料</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="exportSVG" class="export-btn flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-3 rounded-md transition-colors duration-200 text-sm btn-disabled" disabled><i class="o-photo h-5 w-5"></i>SVG</button>
                            <button id="exportPDF" class="export-btn flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-3 rounded-md transition-colors duration-200 text-sm btn-disabled" disabled><i class="o-document-text h-5 w-5"></i>PDF</button>
                            <button id="exportDXF" class="export-btn col-span-2 flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-3 rounded-md transition-colors duration-200 text-sm btn-disabled" disabled><i class="o-document-duplicate h-5 w-5"></i>DXF (for CAD)</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-300 mb-2">3D 模型資料</h3>
                         <div class="grid grid-cols-2 gap-2">
                            <button id="exportOBJ" class="export-btn flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 rounded-md transition-colors duration-200 text-sm btn-disabled" disabled><i class="o-cube h-5 w-5"></i>OBJ</button>
                            <button id="exportSTL" class="export-btn flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 rounded-md transition-colors duration-200 text-sm btn-disabled" disabled><i class="o-cube-transparent h-5 w-5"></i>STL</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
         <footer class="p-4 border-t border-gray-700/60 text-center">
            <p class="text-xs text-gray-500" id="status-text">請先載入地圖</p>
        </footer>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 bg-gray-800 relative">
        <div id="map" class="w-full h-full">
             <div class="w-full h-full flex items-center justify-center bg-gray-800">
                <div class="text-center">
                    <i class="o-map text-gray-600 h-24 w-24"></i>
                    <p class="mt-4 text-lg text-gray-500">地圖未載入</p>
                    <p class="text-sm text-gray-600">請在左側輸入您的 Google Maps API 金鑰</p>
                </div>
            </div>
        </div>
        <div id="loader" class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="text-center text-white">
                <svg class="animate-spin h-8 w-8 text-white mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="loader-text" class="text-lg font-semibold">正在處理...</p>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.137.5/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.137.5/examples/js/exporters/OBJExporter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.137.5/examples/js/exporters/STLExporter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dxf-writer@1.15.0/dist/dxf-writer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@2.2.3/dist/svg2pdf.umd.min.js"></script>
    
    <script>
    // --- Global Variables ---
    let map;
    let googleApiLoaded = false;
    const defaultStyle = [ { "featureType": "all", "elementType": "labels.text.fill", "stylers": [ { "saturation": 36 }, { "color": "#333333" }, { "lightness": 40 } ] }, { "featureType": "all", "elementType": "labels.text.stroke", "stylers": [ { "visibility": "on" }, { "color": "#ffffff" }, { "lightness": 16 } ] }, { "featureType": "all", "elementType": "labels.icon", "stylers": [ { "visibility": "off" } ] }, { "featureType": "administrative", "elementType": "geometry.fill", "stylers": [ { "color": "#fefefe" }, { "lightness": 20 } ] }, { "featureType": "administrative", "elementType": "geometry.stroke", "stylers": [ { "color": "#fefefe" }, { "lightness": 17 }, { "weight": 1.2 } ] }, { "featureType": "landscape", "elementType": "geometry", "stylers": [ { "color": "#f5f5f5" }, { "lightness": 20 } ] }, { "featureType": "poi", "elementType": "geometry", "stylers": [ { "color": "#f5f5f5" }, { "lightness": 21 } ] }, { "featureType": "poi.park", "elementType": "geometry", "stylers": [ { "color": "#dedede" }, { "lightness": 21 } ] }, { "featureType": "road.highway", "elementType": "geometry.fill", "stylers": [ { "color": "#ffffff" }, { "lightness": 17 } ] }, { "featureType": "road.highway", "elementType": "geometry.stroke", "stylers": [ { "color": "#ffffff" }, { "lightness": 29 }, { "weight": 0.2 } ] }, { "featureType": "road.arterial", "elementType": "geometry", "stylers": [ { "color": "#ffffff" }, { "lightness": 18 } ] }, { "featureType": "road.local", "elementType": "geometry", "stylers": [ { "color": "#ffffff" }, { "lightness": 16 } ] }, { "featureType": "transit", "elementType": "geometry", "stylers": [ { "color": "#f2f2f2" }, { "lightness": 19 } ] }, { "featureType": "water", "elementType": "geometry", "stylers": [ { "color": "#e9e9e9" }, { "lightness": 17 } ] } ];

    // --- UI Elements ---
    const apiKeyInput = document.getElementById('apiKeyInput');
    const loadMapBtn = document.getElementById('loadMapBtn');
    const applyStyleBtn = document.getElementById('applyStyleBtn');
    const jsonStyleInput = document.getElementById('jsonStyleInput');
    const exportButtons = document.querySelectorAll('.export-btn');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const statusText = document.getElementById('status-text');

    // --- Initial Setup ---
    window.addEventListener('DOMContentLoaded', () => {
        jsonStyleInput.value = JSON.stringify(defaultStyle, null, 2);
        loadMapBtn.addEventListener('click', loadGoogleMapsAPI);
        applyStyleBtn.addEventListener('click', applyMapStyle);
        
        document.getElementById('exportSVG').addEventListener('click', () => exportData('SVG'));
        document.getElementById('exportPDF').addEventListener('click', () => exportData('PDF'));
        document.getElementById('exportDXF').addEventListener('click', () => exportData('DXF'));
        document.getElementById('exportOBJ').addEventListener('click', () => exportData('OBJ'));
        document.getElementById('exportSTL').addEventListener('click', () => exportData('STL'));
    });

    // --- Core Functions ---
    function loadGoogleMapsAPI() {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
            updateStatus("請提供有效的 Google Maps API 金鑰", true);
            return;
        }
        if (googleApiLoaded) {
            initMap();
            return;
        }
        updateStatus("正在載入 Google Maps API...");
        showLoader("正在載入地圖 API...");
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=geometry,drawing&v=weekly`;
        script.async = true;
        script.defer = true;
        script.onerror = () => {
            hideLoader();
            updateStatus("無法載入 Google Maps API。請檢查您的金鑰和網路連線。", true);
        };
        document.head.appendChild(script);
        googleApiLoaded = true;
    }

    function initMap() {
        hideLoader();
        try {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 25.0330, lng: 121.5654 }, // Taipei 101
                zoom: 15,
                styles: defaultStyle,
                mapTypeControl: false,
                streetViewControl: false,
            });
            updateStatus("地圖載入成功！", false);
            enableControls();
        } catch(e) {
            updateStatus("地圖初始化失敗，請檢查 API 金鑰權限。", true);
            console.error(e);
        }
    }

    function applyMapStyle() {
        if (!map) return;
        try {
            const styles = JSON.parse(jsonStyleInput.value);
            map.setOptions({ styles: styles });
            updateStatus("地圖樣式已更新", false);
        } catch (error) {
            updateStatus("無效的 JSON 樣式格式", true);
            console.error("JSON parsing error:", error);
        }
    }

    function enableControls() {
        applyStyleBtn.disabled = false;
        applyStyleBtn.classList.remove('btn-disabled');
        exportButtons.forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('btn-disabled');
        });
    }
    
    // --- Data Fetching ---
    async function fetchOSMData() {
        if (!map) return null;
        const bounds = map.getBounds();
        const sw = bounds.getSouthWest();
        const ne = bounds.getNorthEast();
        const bbox = `${sw.lat()},${sw.lng()},${ne.lat()},${ne.lng()}`;
        
        const query = `
            [out:json][timeout:30];
            (
              way["building"](${bbox});
              way["highway"](${bbox});
            );
            out geom;
        `;
        
        try {
            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: query
            });
            if (!response.ok) throw new Error(`Overpass API error: ${response.statusText}`);
            const data = await response.json();
            return data.elements;
        } catch (error) {
            updateStatus("無法擷取 OSM 資料", true);
            console.error(error);
            return null;
        }
    }

    // --- Export Logic ---
    async function exportData(format) {
        showLoader(`正在準備 ${format} 檔案...`);
        
        const elements = await fetchOSMData();
        if (!elements) {
            hideLoader();
            return;
        }

        try {
            switch(format) {
                case 'SVG':
                    showLoader('正在生成 SVG...');
                    const svg = generateSVG(elements);
                    downloadFile(svg, 'map_data.svg', 'image/svg+xml');
                    break;
                case 'PDF':
                     showLoader('正在生成 PDF...');
                    await generatePDF(elements);
                    break;
                case 'DXF':
                    showLoader('正在生成 DXF...');
                    const dxf = generateDXF(elements);
                    downloadFile(dxf, 'map_data.dxf', 'application/dxf');
                    break;
                case 'OBJ':
                case 'STL':
                    showLoader('正在生成 3D 場景...');
                    const scene = await generate3DScene(elements);
                    if (format === 'OBJ') {
                         showLoader('正在匯出 OBJ...');
                        const objExporter = new THREE.OBJExporter();
                        const objData = objExporter.parse(scene);
                        downloadFile(objData, 'model.obj', 'text/plain');
                    } else {
                        showLoader('正在匯出 STL...');
                        const stlExporter = new THREE.STLExporter();
                        const stlData = stlExporter.parse(scene, { binary: false });
                        downloadFile(stlData, 'model.stl', 'application/vnd.ms-pki.stl');
                    }
                    break;
            }
            updateStatus(`${format} 匯出成功`, false);
        } catch (error) {
            updateStatus(`${format} 匯出失敗`, true);
            console.error(`Export error for ${format}:`, error);
        } finally {
            hideLoader();
        }
    }

    // --- 2D Generators ---
    function generateSVG(elements) {
        const bounds = map.getBounds();
        const sw = bounds.getSouthWest();
        const ne = bounds.getNorthEast();

        const width = 1000;
        const latRange = ne.lat() - sw.lat();
        const lngRange = ne.lng() - sw.lng();
        const scale = width / lngRange;
        const height = latRange * scale;

        const project = (lat, lon) => {
            const x = (lon - sw.lng()) * scale;
            const y = (ne.lat() - lat) * scale;
            return { x, y };
        };

        let svgPaths = '';
        elements.forEach(el => {
            if (el.geometry && el.geometry.length > 0) {
                const points = el.geometry.map(p => {
                    const proj = project(p.lat, p.lon);
                    return `${proj.x.toFixed(2)},${proj.y.toFixed(2)}`;
                }).join(' ');

                if (el.tags && el.tags.building) {
                    svgPaths += `<polygon points="${points}" fill="#cccccc" stroke="#555555" stroke-width="0.5" />\n`;
                } else if (el.tags && el.tags.highway) {
                    svgPaths += `<polyline points="${points}" fill="none" stroke="#888888" stroke-width="1" />\n`;
                }
            }
        });

        return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${width} ${height}" width="${width}" height="${height}">
            <rect width="100%" height="100%" fill="#f0f0f0" />
            ${svgPaths}
        </svg>`;
    }
    
    async function generatePDF(elements) {
        const { jsPDF } = window.jspdf;
        const svgString = generateSVG(elements);
        const svgElement = new DOMParser().parseFromString(svgString, "image/svg+xml").documentElement;
        
        const width = parseFloat(svgElement.getAttribute('width'));
        const height = parseFloat(svgElement.getAttribute('height'));
        
        const pdf = new jsPDF(width > height ? 'l' : 'p', 'pt', [width, height]);
        
        await pdf.svg(svgElement, {
            x: 0,
            y: 0,
            width: width,
            height: height
        });
        
        pdf.save('map_data.pdf');
    }

    function generateDXF(elements) {
        const d = new DXFWriter();
        d.addLayer('BUILDINGS', DXFWriter.colors.Blue);
        d.addLayer('ROADS', DXFWriter.colors.Red);

        const bounds = map.getBounds();
        const center = bounds.getCenter();

        const project = (lat, lon) => {
           //簡易投影，以米為單位
           const R = 6371000;
           const x = R * (lon - center.lng()) * Math.PI / 180 * Math.cos(center.lat() * Math.PI/180);
           const y = R * (lat - center.lat()) * Math.PI / 180;
           return [x, y];
        }

        elements.forEach(el => {
            if (el.geometry && el.geometry.length > 0) {
                const points = el.geometry.map(p => project(p.lat, p.lon));
                 if (el.tags && el.tags.building) {
                    d.setActiveLayer('BUILDINGS');
                    d.addPolyline(points, true); // true for closed polyline
                } else if (el.tags && el.tags.highway) {
                    d.setActiveLayer('ROADS');
                    d.addPolyline(points, false);
                }
            }
        });

        return d.toDxfString();
    }


    // --- 3D Generator ---
    async function generate3DScene(elements) {
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);

        const bounds = map.getBounds();
        const center = bounds.getCenter();
        const sw = bounds.getSouthWest();
        const ne = bounds.getNorthEast();

        const latSize = google.maps.geometry.spherical.computeDistanceBetween(sw, new google.maps.LatLng(ne.lat(), sw.lng()));
        const lonSize = google.maps.geometry.spherical.computeDistanceBetween(sw, new google.maps.LatLng(sw.lat(), ne.lng()));
        
        // --- Terrain ---
        // 在實際應用中，您會從 DEM (數字高程模型) API 獲取高程數據。
        // 為了演示，我們創建一個稍微起伏的平面。
        const terrainGeometry = new THREE.PlaneGeometry(lonSize, latSize, 50, 50);
        const vertices = terrainGeometry.attributes.position.array;
        for (let i = 2; i < vertices.length; i += 3) {
            vertices[i] = (Math.sin(vertices[i - 2] * 0.01) + Math.cos(vertices[i - 1] * 0.01)) * 10; // 模擬起伏
        }
        terrainGeometry.attributes.position.needsUpdate = true;
        terrainGeometry.computeVertexNormals();
        
        const terrainMaterial = new THREE.MeshStandardMaterial({ color: 0x228B22, flatShading: true });
        const terrain = new THREE.Mesh(terrainGeometry, terrainMaterial);
        scene.add(terrain);

        // --- Buildings ---
        const buildingMaterial = new THREE.MeshStandardMaterial({ color: 0xcccccc, side: THREE.DoubleSide });
        
        const project = (lat, lon) => {
            const y = google.maps.geometry.spherical.computeDistanceBetween(center, new google.maps.LatLng(lat, center.lng())) * (lat > center.lat() ? 1 : -1);
            const x = google.maps.geometry.spherical.computeDistanceBetween(center, new google.maps.LatLng(center.lat(), lon)) * (lon > center.lng() ? 1 : -1);
            return new THREE.Vector2(x, y);
        };
        
        elements.forEach(el => {
            if (el.tags && el.tags.building && el.geometry && el.geometry.length > 2) {
                const shapePoints = el.geometry.map(p => project(p.lat, p.lon));
                const buildingShape = new THREE.Shape(shapePoints);
                
                const height = parseFloat(el.tags['building:levels'] || '3') * 3.5;
                const extrudeSettings = { depth: height, bevelEnabled: false };
                
                const geometry = new THREE.ExtrudeGeometry(buildingShape, extrudeSettings);
                const building = new THREE.Mesh(geometry, buildingMaterial);
                building.position.z = height / 2; // 將建築物底部放在地平面上
                building.rotation.x = -Math.PI / 2; // 從XY平面旋轉到XZ平面
                scene.add(building);
            }
        });

        // --- Lighting ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(100, 200, 150);
        scene.add(directionalLight);
        
        return scene;
    }


    // --- Utility Functions ---
    function showLoader(text) {
        loaderText.textContent = text;
        loader.classList.remove('hidden');
    }

    function hideLoader() {
        loader.classList.add('hidden');
    }

    function updateStatus(message, isError = false) {
        statusText.textContent = message;
        statusText.style.color = isError ? '#f87171' : '#60a5fa';
    }
    
    function downloadFile(content, fileName, contentType) {
        const a = document.createElement("a");
        const file = new Blob([content], { type: contentType });
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(a.href);
    }
    </script>
</body>
</html>
